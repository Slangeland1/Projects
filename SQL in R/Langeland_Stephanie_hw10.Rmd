---
title: "QMSS G5072 Homework 10"
author: Stephanie Langeland 
date: 2017-11-22
always_allow_html: yes
output: 
  html_document:
    keep_md: true
---

Practicing SQL Queries
============================

For this homework, I have prepared a MySQL database hosted on Amazon Web 
Services. Use the code below to connect to the database.

```{r}
library(DBI)
# Connection
witch_con <- dbConnect(RMySQL::MySQL(),
      dbname = "witchcraft",
      host = "tbrambor.cqejfaflibld.us-east-2.rds.amazonaws.com",
      port = 3306,
      user = "student",
      password = "mds-is-fun")

witch_con
```

The data comes from a project on "Scottish Witchcraft" and contains all people 
known to have been accused of witchcraft in early modern Scotland. There is 
information on where and when they were accused, how they were tried, what their 
fate was etc.

>Julian Goodare, Lauren Martin, Joyce Miller and Louise Yeoman, ‘The Survey of Scottish Witchcraft’, http://www.shca.ed.ac.uk/Research/witches/) 

#### 1. Getting to know the data

a) Show a list of the tables included in the database. 

```{r}
table_list <- dbListTables(witch_con)

table_list
```

b) Display the column names for the table `accused`.  

```{r}
accused_table <- DBI::dbReadTable(witch_con, 
                                  "accused")

colnames(accused_table)
```

c) How many people are included in the accused table?  

```{r}
dim(accused_table)
```

There are 3,219 people/observations.

d) Display the columns `firstname`, `sex`, and `age` for 5 cases in the `accused` table.  

```{r}
accused_table[1:5, c(
  "firstname",
  "sex",
  "age"
)]
```

c) Looks like the `age` is missing for some observations. Count the number of 
nonmissing values for age in the data.  

```{r}
summary(is.na(accused_table$age))

summary(accused_table$age == 0)
```

Although there are no blank values for `age`, there are 3,053 cases of ages that
are equal to zero and 166 non-zero ages. 

d) Show a list of unique `occupation`s.

```{r}
unique(accused_table$occupation)
```

#### 2. Seeing the Devil

Let's look at some appearances of the devil in the `devilappearance` table.

a) List the unique `devil_type`s in the data.  

```{r}
devil_table <- DBI::dbReadTable(witch_con, 
                                  "devilappearance")

unique(devil_table$devil_type)
```

b) There is also a little description of the type of the devil sighting in the 
`devil_text` column. How many of the sightings mention the word "black" in the 
description?

```{r}
library(stringr)

devil_table$black <- str_extract_all(devil_table$devil_text,
                                     "black")
  
summary(devil_table$black != "character(0)")
```

There are 113 observations that mention "black".

c) What proportion of the devils (in `devil_type`) are male? 

```{r}
unique(devil_table$devil_type)

devil_table$male <- str_extract_all(devil_table$devil_type,
                                    "Male")

summary(devil_table$male != "character(0)")

 259 / ncol(devil_table) 
```

There are 259 male devils, therefore, the proportion of the male devils is 21.58333.

#### 3. The trial

Let's take a look at the information on the `trial`.

a) What are the average and maximum numbers of male and female accusers?

```{r}
trial_table <- DBI::dbReadTable(witch_con,
                                "trial")

max(trial_table$female_accusers)
mean(trial_table$female_accusers)

max(trial_table$male_accusers)
mean(trial_table$male_accusers)
```

The average and maximum numbers for male accusers are 0.4179383 and 48, respectively.
The average and maximum numbers for female accusers are 0.2556836 and 27, respectively. 

b) Count the number of `sentence`s by sentence type. List them in a table (in 
descending order), excluding missing values. Rename the column headings to something 
sensible.  

```{r, warning = FALSE, message = FALSE}
library(QMSS)
library(dplyr)

sentence_table <- Tab(trial_table$sentence)
sentence_table <- as.data.frame(
  sort(
    sentence_table[-1 , 1],
    decreasing = T))

sentence_table$Sentence_Type <- rownames(sentence_table)
rownames(sentence_table) <- NULL
colnames(sentence_table)[1] <- "Count"

sentence_table 
```

c) Do the number of accusers matter for the `verdict`? Compare the average number 
of accusers by the type of verdict. Again make sure the table is sorted and the 
headings make sense. 

```{r}
verdict_table <- trial_table[ , c("female_accusers", "male_accusers", "verdict")]

verdict_table$N_Accusers <- verdict_table$male_accusers + 
  verdict_table$female_accusers

verdict_table %>%
  group_by(verdict) %>%
  summarize( Mean_Accusers = mean(N_Accusers)) %>%
  arrange(desc(Mean_Accusers))
```

On average, "guilty" verdicts had 5.79 accusers while "not guilty" verdicts had
4.4 accusers.  Also, on average, there was 1 accuser for "not proven" verdicts,
0.286 accusers for "half guilty" verdicts, and 0.201 accusers for missing
verdicts.  It appears that the more accusers there are, the more likely 
a "guilty" verdict will occur. 

